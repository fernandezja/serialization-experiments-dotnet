using PluginDesign.ScreenElements.SequentialElement;
using System;
using System.Collections;
using System.Collections.Generic;
using System.IO;
using System.Runtime.Serialization.Formatters.Binary;

namespace DeserializeObjectFromStringThatIsAnByteArray
{
    class Program
    {
        static void Main(string[] args)
        {
            //String that is an byte array
            string cadena = "0001000000FFFFFFFF010000000000000004010000001C53797374656D2E436F6C6C656374696F6E732E486173687461626C65070000000A4C6F6164466163746F720756657273696F6E08436F6D70617265721048617368436F646550726F7669646572084861736853697A65044B6579730656616C756573000003030005050B081C53797374656D2E436F6C6C656374696F6E732E49436F6D70617265722453797374656D2E436F6C6C656374696F6E732E4948617368436F646550726F766964657208EC51383F060000000A0A0B0000000902000000090300000010020000000600000006040000000A3238373333323131353806050000000A3335353633363139303206060000000A3337353530323330333506070000000A3138373435313433363106080000000A3131303534323836393006090000000A33363330313234343234100300000006000000090A000000090B000000090C000000090D000000090E000000090F0000000C1000000044506C7567696E44657369676E2C2056657273696F6E3D312E312E312E33352C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D6E756C6C040A000000AC0153797374656D2E436F6C6C656374696F6E732E47656E657269632E4C69737460315B5B506C7567696E44657369676E2E53637265656E456C656D656E74732E53657175656E7469616C456C656D656E742E53657175656E7469616C456C656D656E7447432C20506C7567696E44657369676E2C2056657273696F6E3D312E312E312E33352C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D6E756C6C5D5D03000000065F6974656D73055F73697A65085F76657273696F6E04000043506C7567696E44657369676E2E53637265656E456C656D656E74732E53657175656E7469616C456C656D656E742E53657175656E7469616C456C656D656E7447435B5D1000000008080911000000040000000E000000010B0000000A0000000912000000040000000A000000010C0000000A00000009130000000400000008000000010D0000000A00000009140000000400000008000000010E0000000A00000009150000000400000006000000010F0000000A0000000916000000040000000600000007110000000001000000040000000441506C7567696E44657369676E2E53637265656E456C656D656E74732E53657175656E7469616C456C656D656E742E53657175656E7469616C456C656D656E74474310000000091700000009180000000919000000091A00000007120000000001000000040000000441506C7567696E44657369676E2E53637265656E456C656D656E74732E53657175656E7469616C456C656D656E742E53657175656E7469616C456C656D656E74474310000000091B000000091C000000091D000000091E00000007130000000001000000040000000441506C7567696E44657369676E2E53637265656E456C656D656E74732E53657175656E7469616C456C656D656E742E53657175656E7469616C456C656D656E74474310000000091F00000009200000000921000000092200000007140000000001000000040000000441506C7567696E44657369676E2E53637265656E456C656D656E74732E53657175656E7469616C456C656D656E742E53657175656E7469616C456C656D656E74474310000000092300000009240000000925000000092600000007150000000001000000040000000441506C7567696E44657369676E2E53637265656E456C656D656E74732E53657175656E7469616C456C656D656E742E53657175656E7469616C456C656D656E74474310000000092700000009280000000929000000092A00000007160000000001000000040000000441506C7567696E44657369676E2E53637265656E456C656D656E74732E53657175656E7469616C456C656D656E742E53657175656E7469616C456C656D656E74474310000000092B000000092C000000092D000000092E000000051700000041506C7567696E44657369676E2E53637265656E456C656D656E74732E53657175656E7469616C456C656D656E742E53657175656E7469616C456C656D656E744743020000000A5F4964456C656D656E74105F457374696D756C6F4372697469636F01000110000000062F0000000A323939353736393637330001180000001700000006300000000A313032363834323132320001190000001700000006310000000A3431313532383230323200011A0000001700000006320000000A3235323033303935363601011B0000001700000006330000000936343436393536323600011C0000001700000006340000000A3231393237313935353100011D0000001700000006350000000931363238393630343000011E0000001700000006360000000A3330333033363235393701011F0000001700000006370000000A323939353736393637330001200000001700000006380000000A313939323930333235370001210000001700000006390000000A3335303631393332353601012200000017000000063A0000000A3338323035343039343600012300000017000000063B0000000A3136303933353138303900012400000017000000063C0000000A3235373936393632383000012500000017000000063D0000000A3130323638343231323201012600000017000000063E0000000A3335393934373135303200012700000017000000063F0000000A31303735343136343233000128000000170000000640000000093834363832363533380101290000001700000006410000000A3232313534313438313100012A0000001700000006420000000A3336333839373438383700012B0000001700000006430000000A3330333033363235393700012C0000001700000006440000000A3337393035323432363001012D0000001700000006450000000A3130323638343231323200012E0000001700000006460000000A33393135313135313033000B000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";

            int max = cadena.Length / 2;
            byte[] buffer = new byte[max];
            for (int i = 0; i <= max - 1; i++)
            {
                buffer[i] = Convert.ToByte(cadena.Substring(i * 2, 2), 16);
            }

            var bufferEnCadena = System.Text.Encoding.Default.GetString(buffer);

            Console.WriteLine(bufferEnCadena);

            var hashTableUnserialize2 = ByteArrayToObject<Hashtable>(buffer);

            Console.WriteLine("----------------------------------------------------------------");
            Console.WriteLine("Keys");
            foreach (var key in hashTableUnserialize2.Keys)
            {
                Console.WriteLine($" - Key > {key}");
            }

            Console.WriteLine("----------------------------------------------------------------");
            Console.WriteLine("Content");
            foreach (var key in hashTableUnserialize2.Keys)
            {
                Console.WriteLine($" - Key > {key}");
                Console.WriteLine($" - Content");
                var list = (List<SequentialElementGC>)(hashTableUnserialize2[key]);
                var index = 0;
                
                foreach (var item in list)
                {
                    Console.WriteLine($" - Item {index}");
                    Console.WriteLine($"        - Id > {item.Id}");
                    Console.WriteLine($"        - EstimuloCritico > {item.EstimuloCritico}");
                    Console.WriteLine($"        - IdElement > {item.IdElement}");
                    index++;
                }
                
                Console.WriteLine();
            }

            Console.ReadKey();
        }

        private static byte[] ObjectToByteArray(object obj)
        {
            if (obj == null)
                return null;

            BinaryFormatter bf = new BinaryFormatter();
            using (MemoryStream ms = new MemoryStream())
            {
                bf.Serialize(ms, obj);
                return ms.ToArray();
            }
        }


        /// <summary>
        /// Error	SYSLIB0011	'BinaryFormatter.Deserialize(Stream)' is obsolete: 'BinaryFormatter serialization is obsolete and should not be used. See https://aka.ms/binaryformatter for more information.'
        /// https://learn.microsoft.com/es-es/dotnet/core/compatibility/core-libraries/5.0/binaryformatter-serialization-obsolete
        /// </summary>
        /// <typeparam name="T"></typeparam>
        /// <param name="data"></param>
        /// <returns></returns>
        [Obsolete("")]
        private static T ByteArrayToObject<T>(byte[] data)
        {
            using (MemoryStream ms = new MemoryStream())
            {
                var binaryFormatter = new BinaryFormatter();
                ms.Write(data, 0, data.Length);
                ms.Seek(0, SeekOrigin.Begin);
                T obj = (T)binaryFormatter.Deserialize(ms);
                return obj;
            }
        }
    }
}
